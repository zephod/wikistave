var SVGUtil=SVGUtil||{};SVGUtil.translatePath=function(a,b,d){return SVGUtil.transformPath(a,function(a,f){return{x:a+b,y:f+d}})};SVGUtil.scalePath=function(a,b){return SVGUtil.transformPath(a,function(a,c){return{x:a*b,y:c*b}})};SVGUtil.integerPath=function(a){return SVGUtil.transformPath(a,function(b,a){return{x:Math.round(b),y:Math.round(a)}})};
SVGUtil.transformPath=function(a,b){return path=_.map(path,function(a){return-1<a.indexOf(",")?(a=a.split(","),a=b(parseFloat(a[0]),parseFloat(a[1])),a.x+","+a.y):a})};SVGUtil.pathStringToArray=function(a){function b(a){return/[0-9.,-]/.test(a)?"number":/[a-zA-Z]/.test(a)?"character":"other"}for(var d=[],c=0;c<a.length;){for(var f=b(a.charAt(c)),e=c+1;b(a.charAt(e))==f;)e++;("number"==f||"character"==f)&&d.push(a.substring(c,e));c=e}return d};var debug=SVGUtil.pathStringToArray;var App=App||{Vectors:{}};
App.Vectors.Vector=function(a){_.extend(this,a);if(!this.path)throw"Error: Vector is missing path";this.attr={stroke:"none",fill:"#000"};this.translate_y=this.translate_x=0;this.scale=1;this.moveTo=function(a,d){this.translate_x+=a;this.translate_y+=d;return this.render()};this.setScale=function(a){this.scale=a;return this.render()};this.render=function(){this.vector&&this.vector.remove();this.vector=App.paper.path(this.path);this.vector.attr(this.attr);this.vector.translate(this.translate_x-this.cx,
this.translate_y-this.cy);this.vector.scale(this.scale,this.scale,this.cx,this.cy);return this};this.color=function(a){this.attr.fill=a;this.render();return this};this.render();return this};
App.Vectors.clef={path:{g:"M 44,-192 C 47,-156 21,-127 -3,-103 -14,-93 -5,-102 -11,-97 -12,-102 -14,-117 -14,-121 -12,-152 13,-197 35,-213 39,-207 42,-206 44,-192 z M 51,-6 C 37,-17 18,-19 1,-16 -1,-31 -3,-45 -5,-60 22,-87 51,-118 53,-158 54,-184 50,-212 34,-233 14,-231 0,-208 -10,-193 -27,-163 -23,-125 -17,-92 -26,-81 -39,-72 -48,-61 -75,-34 -99,2 -94,42 -92,80 -65,116 -27,125 -12,129 3,129 17,126 20,152 29,179 18,205 10,223 -14,239 -32,230 -38,226 -33,229 -37,227 -25,224 -14,215 -11,209 -1,192 -16,167 -36,170 -62,171 -73,206 -56,224 -40,242 -12,239 7,228 28,214 30,187 28,164 27,156 23,133 23,125 31,122 25,124 36,120 67,107 87,70 78,37 74,21 66,4 51,-6 z M 58,60 C 60,83 46,110 22,117 21,108 20,106 19,100 14,72 11,43 6,14 25,12 46,20 53,39 56,46 57,53 58,60 z M -2,120 C -31,122 -59,102 -66,73 -75,48 -73,20 -57,-2 -44,-22 -27,-38 -11,-54 -8,-41 -6,-28 -4,-15 -39,-6 -62,39 -41,70 -35,79 -19,96 -9,89 -22,81 -33,68 -30,52 -31,37 -15,19 0,15 5,48 11,85 16,118 10,119 4,120 -2,120 z",f:"M 40,-51 C 40,-22 27,7 7,27 C -19,53 -53,69 -88,80 C -92,83 -99,80 -92,76 C -78,70 -64,64 -51,56 C -23,38 1,11 7,-23 C 11,-43 10,-64 4,-85 C 1,-99 -10,-115 -26,-117 C -40,-119 -56,-114 -66,-103 C -69,-100 -75,-93 -74,-84 C -67,-89 -68,-88 -63,-90 C -51,-96 -35,-88 -32,-75 C -29,-63 -32,-48 -43,-42 C -56,-35 -74,-38 -81,-51 C -92,-71 -86,-99 -68,-113 C -49,-129 -21,-129 1,-121 C 23,-113 37,-89 39,-66 C 40,-61 40,-56 40,-51 z M 85,-33 C 85,-29 83,-25 80,-23 C 76,-19 71,-19 66,-20 C 61,-22 58,-27 58,-32 C 57,-36 59,-40 61,-42 C 64,-45 68,-47 72,-46 C 77,-46 81,-43 83,-38 C 84,-37 85,-35 85,-33 z M 85,-94 C 85,-90 83,-86 80,-83 C 76,-80 71,-79 66,-81 C 61,-83 58,-87 58,-92 C 57,-96 58,-100 61,-103 C 64,-106 68,-107 72,-107 C 76,-107 79,-105 82,-102 C 84,-100 85,-97 85,-94 z",
c:"M -61,128 L -91,128 L -91,-127 L -61,-127 L -61,128 z M 82,74 C 81,94 70,116 50,123 C 32,130 11,131 -4,119 C -15,110 -20,91 -8,82 C 3,71 25,81 23,96 C 28,107 5,113 17,121 C 31,125 45,113 48,100 C 53,82 53,61 49,43 C 46,33 40,19 28,23 C 12,26 3,42 -2,57 C -5,36 -18,19 -32,5 C -32,46 -32,87 -32,128 L -42,128 C -42,44 -42,-42 -42,-127 L -32,-127 C -32,-86 -32,-44 -32,-4 C -18,-17 -5,-35 -2,-55 C 3,-40 13,-23 31,-21 C 43,-20 47,-36 50,-45 C 53,-64 53,-83 47,-101 C 43,-113 30,-124 16,-120 C 6,-112 27,-107 23,-96 C 26,-82 7,-70 -5,-78 C -18,-85 -17,-105 -7,-115 C 0,-122 13,-127 23,-127 C 33,-127 39,-126 48,-123 C 68,-116 81,-95 82,-74 C 85,-51 72,-25 50,-16 C 36,-10 19,-15 8,-25 C 6,-15 2,-5 -4,2 C 1,9 6,21 8,25 C 22,13 46,11 61,24 C 75,36 84,55 82,74 z"},
w:190,h:256};App.Vectors.crotchetDown={path:"M161.7,32 c 2.8,4.8 -0.2,11.7 -6.6,15.5 c -6.4,3.8 -13.9,3 -16.7,-1.8 c -2.8,-4.8 0.2,-11.7 6.6,-15.5 C 151.4,26.5 158.9,27.3 161.7,32z M138.8,108.2h-1.5v-66h1.5V108.2z",cx:149,cy:39,h:150};App.Vectors.crotchetUp={path:"M51.2,0h1.5v66h-1.5V0z M28.3,76.1c-2.8-4.8,0.2-11.7,6.6-15.4s13.9-3,16.7,1.8c2.8,4.8-0.2,11.7-6.6,15.5C38.6,81.7,31.1,80.9,28.3,76.1z",cx:40,cy:69,h:150};
App.Vectors.crotchetRest={path:"M254.4,20.8c1.5,1.6,13,15.7,13,15.7s-6.4,6.1-6.4,12.5c0,7.5,8.6,14.3,8.6,14.3l-0.9,1.1c-3.3-1.9-8.9-2.1-11.4,0.8 c-3.1,3.6,3.9,9.1,3.9,9.1l-0.8,1.1c-2.4-1.8-12.6-11.4-8.3-16.1c2.6-2.9,5.8-3.8,10.3-1.4l-12.1-12.5c7-8.6,8.2-11.1,8.2-13.4 c0-4.8-3.4-8.2-5.1-10.4c-0.6-0.9-1.7-1.6-1-2.2C253.1,18.9,253.5,19.7,254.4,20.8z",cx:258,cy:49,h:180};App.Vectors.crosshair=function(a,b,d){a+=0.5;b+=0.5;void 0===d&&(d=10);return["M"+(a-d),b,"h",2*d,"M",a,b-d,"v",2*d]};App=App||{};App.Util=App.Util||{};App.Model=App.Model||{};App.View=App.View||{};App.Model.Note=Backbone.Model.extend({defaults:{line:3,duration:256,rest:!1},pitchUp:function(){this.set("line",this.get("line")-1)}});App.Model.Stave=Backbone.Model.extend({initialize:function(){this.notes.bind("all",function(a){this.change(a)},this)},defaults:{clefName:null},notes:new (Backbone.Collection.extend({model:App.Model.Note}))});
App.View.Stave=Backbone.View.extend({initialize:function(){if(!this.options.clefSpace)this.options.clefSpace=this.options.h/8;this.model.bind("change",this.render,this);this.noteVectors=[];this.render()},setPosition:function(a){_.extend(this.options,a);this.render()},render:function(){this.clef&&this.clef.remove();this.stave&&this.stave.remove();var a=this;_.each(this.noteVectors,function(a){a.remove()});this.noteVectors=[];for(var b=this.options,d=b.h/4,c="",f=0;5>f;f++)c+=["M",b.x,Math.round(b.y+
f*d)+0.5,"h",b.w];this.stave=App.paper.path(c);if(c=App.Vectors.clef.path[this.model.get("clefName")]){var e=b.h/App.Vectors.clef.h;this.clef=App.paper.path(c).attr(App.Util.blackFill);this.clef.translate(b.x+App.Vectors.clef.w*e/2+b.clefSpace,b.y+b.h/2);this.clef.scale(e,e,0,0)}var g=b.x+b.clefSpace+App.Vectors.clef.w*e+2*d,h=2.3*d;this.model.notes.each(function(c){var f=b.y+d*(c.get("line")-1),e=2<c.get("line")?App.Vectors.crotchetUp:App.Vectors.crotchetDown;if(c.get("rest"))e=App.Vectors.crotchetRest;
c=new App.Vectors.Vector(e);c.moveTo(g,f);c.setScale(e.h/256);a.noteVectors.push(c.vector);g+=h})}});App.Util.blackFill={stroke:"none",fill:"#000"};App.Util.redLines={stroke:"#f00"};
$(function(){App.paper=Raphael("holder",800,380);new Backbone.Model({a:1});var a=new App.Model.Stave({clefName:"g"});new App.View.Stave({x:10,y:120,w:800,h:60,model:a});$("button.js-note").click(function(b){b=b.target.value;"rest"==b?(console.log(asdf),a.notes.add({rest:!0})):"start over"==b?a.notes.reset():a.notes.add({line:b})});$("input.js-clef").click(function(b){b=b.target.value;a.set({clefName:b});$("div.js-clef").hide();$("div.js-clef."+b).css({display:"inline"});a.notes.reset()})});
